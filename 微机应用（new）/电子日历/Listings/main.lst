C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.H>
   2          #include <DS1302.H>
   3          #include "LCD1602.h"
   4          #include "LED.h"
   5          #include <intrins.h>
   6          int key_flag = 0;                       
   7          unsigned        char key_value = 0xff;
   8          unsigned char mode=0;
   9          
  10          void cls_buzz(void)     
  11          {
  12   1          P2 = (P2 & 0x1F | 0xA0);
  13   1          P0 = 0x00;
  14   1          P2 &= 0x1F;
  15   1      }
  16          
  17          void open_buzz(void)
  18          {
  19   1                      P2 = (P2 & 0x1F | 0xA0);
  20   1          P0 = 0xFF;
  21   1          P2 &= 0x1F;
  22   1      }
  23          
  24          void alarm(void)
  25          {
  26   1                      if((DS1302_Time[3]==alarm_Time[0])&(DS1302_Time[4]==alarm_Time[1])&(DS1302_Time[5]==alarm_Time[2]))
  27   1                      {
  28   2                                      if(DS1302_Time[6]<=5&alarm_Time[3]==0) 
  29   2                                      open_buzz();
  30   2                                      if(DS1302_Time[6]>5&alarm_Time[3]==1)
  31   2                                      open_buzz();
  32   2                      }                       
  33   1                      if(DS1302_Time[5]==alarm_Time[2]+10)
  34   1                      cls_buzz();
  35   1      
  36   1      }
  37          
  38          void Day_Show()//显示星期
  39          {
  40   1                      switch(DS1302_Time[6])
  41   1                      {
  42   2                              case 1:
  43   2                                      LCD_Display_String(1,14,"MON");
  44   2                              break;
  45   2                              case 2:
  46   2                                      LCD_Display_String(1,14,"TUE");
  47   2                              break;
  48   2                              case 3:
  49   2                                      LCD_Display_String(1,14,"WEN");
  50   2                              break;
  51   2                              case 4:
  52   2                                      LCD_Display_String(1,14,"THU");
  53   2                              break;
  54   2                              case 5:
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 2   

  55   2                                      LCD_Display_String(1,14,"FRI");
  56   2                              break;
  57   2                              case 6:
  58   2                                      LCD_Display_String(1,14,"SAT");
  59   2                              break;
  60   2                              case 7:
  61   2                                      LCD_Display_String(1,14,"SUN");
  62   2                              break;
  63   2                      }
  64   1       
  65   1      }
  66          void ClockDay_Show()//显示闹钟工作状态
  67          {
  68   1                      switch(alarm_Time[3])
  69   1                      {
  70   2                              case 0:
  71   2                                      LCD_Display_String(2,1,"Weekday");
  72   2                              break;
  73   2                              case 1:
  74   2                                      LCD_Display_String(2,1,"Weekend");
  75   2                              break;
  76   2                      }
  77   1       
  78   1      }
  79          void read_keyboard(void)//矩阵键盘读取
  80          {
  81   1        static unsigned char hang;
  82   1              static unsigned char key_state=0;       
  83   1              switch(key_state)
  84   1              {
  85   2                      case 0:
  86   2                      {
  87   3                              P3 = 0x0f; P42 = 0; P44 = 0;
  88   3                              if(P3 != 0x0f) //有按键按下
  89   3                              key_state=1;    
  90   3                      }
  91   2                      break;
  92   2                      case 1:
  93   2                      {
  94   3                              P3 = 0x0f; P42 = 0; P44 = 0;
  95   3                              if(P3 != 0x0f) //有按键按下
  96   3                              {
  97   4                                      if(P30 == 0)hang = 1;
  98   4                                      if(P31 == 0)hang = 2;
  99   4                                      if(P32 == 0)hang = 3;
 100   4                                      if(P33 == 0)hang = 4;//确定行       
 101   4                                      switch(hang){
 102   5                                              case 1:{P3 = 0xf0; P42 = 1; P44 = 1;
 103   6                                                      if(P44 == 0)              {key_value=0;key_state=2;}//S7按下
 104   6                                                      else if(P42 == 0) {key_value=1;key_state=2;}//S11按下
 105   6                                                      else if(P35 == 0) {key_value=2;key_state=2;}//S15按下
 106   6                                                      else if(P34 == 0) {key_value=3;key_state=2;}//S19按下
 107   6                                              }
 108   5                                              break;
 109   5                                              case 2:{P3 = 0xf0; P42 = 1; P44 = 1;
 110   6                                                      if(P44 == 0)                    {key_value=4;key_state=2;}//S6按下
 111   6                                                      else if(P42 == 0) {key_value=5;key_state=2;}//S10按下
 112   6                                                      else if(P35 == 0) {key_value=6;key_state=2;}//S14按下
 113   6                                                      else if(P34 == 0) {key_value=7;key_state=2;}//S18按下
 114   6                                              }
 115   5                                              break;
 116   5                                              case 3:{P3 = 0xf0; P42 = 1; P44 = 1;
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 3   

 117   6                                                      if(P44 == 0)                    {key_value=8;key_state=2;}//S5按下
 118   6                                                      else if(P42 == 0) {key_value=9;key_state=2;}//S9按下
 119   6                                                      else if(P35 == 0) {key_value=10;key_state=2;}//S13按下
 120   6                                                      else if(P34 == 0) {key_value=11;key_state=2;}//S17按下
 121   6                                              }
 122   5                                              break;
 123   5                                              case 4:{P3 = 0xf0; P42 = 1; P44 = 1;
 124   6                                                      if(P44 == 0)                    {key_value=12;key_state=2;}//S4按下
 125   6                                                      else if(P42 == 0) {key_value=13;key_state=2;}//S8按下
 126   6                                                      else if(P35 == 0) {key_value=14;key_state=2;}//S12按下
 127   6                                                      else if(P34 == 0) {key_value=15;key_state=2;}//S16按下
 128   6                                              }
 129   5                                              break;
 130   5                                      }       
 131   4                              }
 132   3                              else
 133   3                              {
 134   4                                      key_state=0;    
 135   4                              }          
 136   3                      }
 137   2                      break;
 138   2                      case 2:     
 139   2                      {
 140   3                              P3 = 0x0f; P42 = 0; P44 = 0;
 141   3                              if(P3 == 0x0f) //按键放开
 142   3                              key_state=0;    
 143   3                      }
 144   2                      break;                  
 145   2          } 
 146   1      }
 147          void KeyAction()
 148          {
 149   1              switch(key_value)
 150   1              {
 151   2                      case 0:
 152   2                              mode=1;
 153   2                              LED(0xfe);
 154   2                      break;
 155   2                      case 1:
 156   2                              mode=2;
 157   2                              LED(0xfd);
 158   2                      break;
 159   2                      case 2:
 160   2                              mode=3;
 161   2                              LED(0xfb);
 162   2                      break;
 163   2                      case 4:
 164   2                              mode=4;
 165   2                              LED(0xf7);
 166   2                      break;
 167   2                      case 5:
 168   2                              mode=5;
 169   2                              LED(0xef);
 170   2                      break;
 171   2                      case 6:
 172   2                              mode=6;
 173   2                              LED(0xdf);
 174   2                      break;
 175   2                      case 8:
 176   2                              mode=7;
 177   2                              LED(0xbf);
 178   2                      break;
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 4   

 179   2                      case 14://修改取消
 180   2                              LCD_Init();
 181   2                              mode=0;
 182   2                      break;
 183   2                      case 15:
 184   2                              mode=15;
 185   2                              LED(0xff);
 186   2                      break;
 187   2                      case 13:  
 188   2           mode = 19;
 189   2           LED(0xbf); 
 190   2          break;      
 191   2          case 9:  
 192   2           mode = 20;  
 193   2          break;
 194   2          case 10: 
 195   2           mode = 21;  
 196   2          break;
 197   2          case 11: 
 198   2           mode = 22;  
 199   2          break;      
 200   2                      case 12: 
 201   2                       mode = 23;  
 202   2                      break;
 203   2              }
 204   1      }
 205          void Disply()
 206          {
 207   1              switch(mode)
 208   1              {
 209   2                      case 0:
 210   2                              DS1302_Time_ReLoad();
 211   2                              LCD_Display_String(1,1,"DATE:");
 212   2                              LCD_Display_String(2,1,"TIME:");
 213   2                              LCD_Display_String(1,8,"-");
 214   2                              LCD_Display_String(1,11,"-");   
 215   2                              LCD_Display_String(2,8,":");
 216   2                              LCD_Display_String(2,11,":");
 217   2                              DS1302_ReadTime();
 218   2                              DS1302_ShowTime();
 219   2                              Day_Show();
 220   2                              break;
 221   2                      case 1://修改年份
 222   2                              LCD_Display_String(1,1,"YearSet      ");
 223   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[0]);
 224   2                              if(key_value==3)//+1年
 225   2                              {
 226   3                                      Temp_DS1302_Time[0]++;
 227   3                                      if(Temp_DS1302_Time[0]>99){Temp_DS1302_Time[0]=0;}
 228   3                              }
 229   2                              if(key_value==7)//-1年
 230   2                              {
 231   3                                      Temp_DS1302_Time[0]--;
 232   3                                      if(Temp_DS1302_Time[0]<0){Temp_DS1302_Time[0]=99;}      
 233   3                              }
 234   2                              break;
 235   2                              
 236   2                      case 2://月修改
 237   2                              LCD_Display_String(1,1,"MonthSet   ");
 238   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[1]);
 239   2       
 240   2                              if(key_value==3)//+1月
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 5   

 241   2                              {
 242   3                                      Temp_DS1302_Time[1]++;
 243   3                                      if(Temp_DS1302_Time[1]>12){Temp_DS1302_Time[1]=1;}
 244   3                              }
 245   2                              if(key_value==7)//-1月
 246   2                              {
 247   3                                      Temp_DS1302_Time[1]--;
 248   3                                      if(Temp_DS1302_Time[1]<1){Temp_DS1302_Time[1]=12;}
 249   3                              }
 250   2                              break;
 251   2              
 252   2                      case 3://日修改
 253   2                              LCD_Display_String(1,1,"DateSet      ");
 254   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[2]);
 255   2                              
 256   2                              if(key_value==3)//+1日
 257   2                              {
 258   3                                      Temp_DS1302_Time[2]++;
 259   3                                      if( Temp_DS1302_Time[1]==1 || Temp_DS1302_Time[1]==3 || Temp_DS1302_Time[1]==5 || Temp_DS1302_Time[1]=
             -=7 || 
 260   3                                                      Temp_DS1302_Time[1]==8 || Temp_DS1302_Time[1]==10 || Temp_DS1302_Time[1]==12)//大月
 261   3                                      {
 262   4                                                      if(Temp_DS1302_Time[2]>31){Temp_DS1302_Time[2]=1;}//1-31
 263   4                                      }
 264   3                                      else if(Temp_DS1302_Time[1]==4 || Temp_DS1302_Time[1]==6 || Temp_DS1302_Time[1]==9 || Temp_DS1302_Time
             -[1]==11)//小月
 265   3                                      {
 266   4                                                      if(Temp_DS1302_Time[2]>30){Temp_DS1302_Time[2]=1;}//1-30
 267   4                                      }
 268   3                                      else if(Temp_DS1302_Time[1]==2)//平月
 269   3                                      {
 270   4                                                      if(Temp_DS1302_Time[0]%4==0&&Temp_DS1302_Time[0]%100!=0)//闰年
 271   4                                                      {
 272   5                                                              if(Temp_DS1302_Time[2]>29){Temp_DS1302_Time[2]=1;}
 273   5                                                      }
 274   4                                                      else if(Temp_DS1302_Time[0]%400==0)
 275   4                                                      {
 276   5                                                              if(Temp_DS1302_Time[2]>29){Temp_DS1302_Time[2]=1;}
 277   5                                                      }
 278   4                                                      else     //平年
 279   4                                                      {
 280   5                                                              if(Temp_DS1302_Time[2]>28){Temp_DS1302_Time[2]=1;}
 281   5                                                      }
 282   4                                      }
 283   3                                      Temp_DS1302_Time[6]++;
 284   3                                      if(Temp_DS1302_Time[6]>7){Temp_DS1302_Time[6]=1;}
 285   3                              }
 286   2                              if(key_value==7)//-1日
 287   2                              {
 288   3                                      Temp_DS1302_Time[2]--;
 289   3                                      if( Temp_DS1302_Time[1]==1 || Temp_DS1302_Time[1]==3 || Temp_DS1302_Time[1]==5 || Temp_DS1302_Time[1]=
             -=7 || 
 290   3                                                      Temp_DS1302_Time[1]==8 || Temp_DS1302_Time[1]==10 || Temp_DS1302_Time[1]==12)
 291   3                                      {
 292   4                                                      if(Temp_DS1302_Time[2]<1){Temp_DS1302_Time[2]=31;}
 293   4                                                      if(Temp_DS1302_Time[2]>31){Temp_DS1302_Time[2]=1;}
 294   4                                      }
 295   3                                      else if(Temp_DS1302_Time[1]==4 || Temp_DS1302_Time[1]==6 || Temp_DS1302_Time[1]==9 || Temp_DS1302_Time
             -[1]==11)
 296   3                                      {
 297   4                                                      if(Temp_DS1302_Time[2]<1){Temp_DS1302_Time[2]=30;}
 298   4                                                      if(Temp_DS1302_Time[2]>30){Temp_DS1302_Time[2]=1;}
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 6   

 299   4                                      }
 300   3                                      else if(Temp_DS1302_Time[1]==2)
 301   3                                      {
 302   4                                                      if(Temp_DS1302_Time[0]%4==0&&Temp_DS1302_Time[0]%100!=0)
 303   4                                                      {
 304   5                                                              if(Temp_DS1302_Time[2]<1){Temp_DS1302_Time[2]=29;}
 305   5                                                              if(Temp_DS1302_Time[2]>29){Temp_DS1302_Time[2]=1;}
 306   5                                                      }
 307   4                                                      else if(Temp_DS1302_Time[0]%400==0)
 308   4                                                      {
 309   5                                                              if(Temp_DS1302_Time[2]<1){Temp_DS1302_Time[2]=29;}
 310   5                                                              if(Temp_DS1302_Time[2]>29){Temp_DS1302_Time[2]=1;}
 311   5                                                      }
 312   4                                                      else
 313   4                                                      {
 314   5                                                              if(Temp_DS1302_Time[2]<1){Temp_DS1302_Time[2]=28;}
 315   5                                                              if(Temp_DS1302_Time[2]>28){Temp_DS1302_Time[2]=1;}
 316   5                                                      }
 317   4                                      }
 318   3                                      Temp_DS1302_Time[6]--;
 319   3                                      if(Temp_DS1302_Time[6]==0){Temp_DS1302_Time[6]=7;}      
 320   3                              }
 321   2       
 322   2                              break;
 323   2                              
 324   2                              
 325   2                      case 4://时修改
 326   2                              LCD_Display_String(1,1,"HourSet      ");
 327   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[3]);
 328   2                              
 329   2                              if(key_value==3)//+1时
 330   2                              {
 331   3                                      Temp_DS1302_Time[3]++;
 332   3                                      if(Temp_DS1302_Time[3]>23){Temp_DS1302_Time[3]=0;}//24进制
 333   3                              }
 334   2                              if(key_value==7)//-1时
 335   2                              {
 336   3                                      Temp_DS1302_Time[3]--;
 337   3                              if(Temp_DS1302_Time[3]<0){Temp_DS1302_Time[3]=23;}
 338   3                              }
 339   2                              break;
 340   2                      case 5://分修改
 341   2                              LCD_Display_String(1,1,"MinuteSet  ");
 342   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[4]);
 343   2                              
 344   2                              if(key_value==3)//+1分
 345   2                              {
 346   3                                      Temp_DS1302_Time[4]++;
 347   3                                      if(Temp_DS1302_Time[4]>59){Temp_DS1302_Time[4]=0;}//60进制
 348   3                              }
 349   2                              if(key_value==7)//-1分
 350   2                              {
 351   3                                      Temp_DS1302_Time[4]--;
 352   3                                      if(Temp_DS1302_Time[4]<0){Temp_DS1302_Time[4]=59;}
 353   3                              }
 354   2                              break;
 355   2                      case 6://秒修改
 356   2                              LCD_Display_String(1,1,"SecondSet     ");
 357   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[5]);
 358   2                              
 359   2                              if(key_value==3)//+1秒
 360   2                              {
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 7   

 361   3                                      Temp_DS1302_Time[5]++;
 362   3                                      if(Temp_DS1302_Time[5]>59){Temp_DS1302_Time[5]=0;}//60进制
 363   3                              }
 364   2                              if(key_value==7)//-1秒
 365   2                              {
 366   3                                      Temp_DS1302_Time[5]--;
 367   3                                      if(Temp_DS1302_Time[5]<0){Temp_DS1302_Time[5]=59;}
 368   3                              }
 369   2                              break;
 370   2                      case 7://星期修改
 371   2                              LCD_Display_String(1,1,"DaySet          ");
 372   2                              LCD_WriteNum(2,1,2,0,Temp_DS1302_Time[6]);      
 373   2                              if(key_value==3)
 374   2                              {
 375   3                                      Temp_DS1302_Time[6]++;
 376   3                                      if(Temp_DS1302_Time[6]>7){Temp_DS1302_Time[6]=1;}
 377   3                              }
 378   2                              if(key_value==7)
 379   2                              {
 380   3                                      Temp_DS1302_Time[6]--;
 381   3                                      if(Temp_DS1302_Time[6]==0){Temp_DS1302_Time[6]=7;}      
 382   3                              }
 383   2                              break;
 384   2                      case 15://修改确认
 385   2                              LCD_Init();
 386   2                              DS1302_Time_Load();
 387   2                              DS1302_Time_ReLoad();
 388   2                              DS1302_ReSetTime();
 389   2                              mode=0;
 390   2                      break;
 391   2                      case 19: // 闹钟设置界面
 392   2                  LCD_Display_String(1, 1, "CLOCK SET");
 393   2                                                      ClockDay_Show();
 394   2                  LCD_WriteNum(2, 9, 2, 0, alarm_Time[0]);
 395   2                  LCD_Display_Char(2, 11, ':');
 396   2                  LCD_WriteNum(2, 12, 2, 0, alarm_Time[1]);
 397   2                  LCD_Display_Char(2, 14, ':');
 398   2                  LCD_WriteNum(2, 15, 2, 0, alarm_Time[2]);
 399   2                  break;
 400   2      
 401   2          case 20: // 设置闹钟小时
 402   2                  LCD_Display_String(1, 1, "CLOCK_HourSet");
 403   2                  LCD_WriteNum(2, 1, 2, 0, alarm_Time[0]);
 404   2                  if (key_value == 3) { // +1 小时
 405   3                      alarm_Time[0] = (alarm_Time[0] + 1) % 24;
 406   3                  }
 407   2                  if (key_value == 7) { // -1 小时
 408   3                      alarm_Time[0] = (alarm_Time[0] == 0) ? 23 : alarm_Time[0] - 1;
 409   3                  }
 410   2                  break;
 411   2                                                      
 412   2          case 21: // 设置闹钟分钟
 413   2                  LCD_Display_String(1, 1, "CLOCK_MinuteSet");
 414   2                  LCD_WriteNum(2, 1, 2, 0, alarm_Time[1]);
 415   2                  if (key_value == 3) { // +1 分钟
 416   3                      alarm_Time[1] = (alarm_Time[1] + 1) % 60;
 417   3                  }
 418   2                  if (key_value == 7) { // -1 分钟
 419   3                      alarm_Time[1] = (alarm_Time[1] == 0) ? 59 : alarm_Time[1] - 1;
 420   3                  }
 421   2                  break;
 422   2      
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 8   

 423   2          case 22: // 设置闹钟秒钟
 424   2                  LCD_Display_String(1, 1, "CLOCK_SecondSet");
 425   2                  LCD_WriteNum(2, 1, 2, 0, alarm_Time[2]);
 426   2                  if (key_value == 3) { // +1 秒
 427   3                      alarm_Time[2] = (alarm_Time[2] + 1) % 60;
 428   3                  }
 429   2                  if (key_value == 7) { // -1 秒
 430   3                      alarm_Time[2] = (alarm_Time[2] == 0) ? 59 : alarm_Time[2] - 1;
 431   3                  }
 432   2                  break;
 433   2                      case 23: // 设置闹钟工作状态
 434   2                 LCD_Display_String(1,1,"CLOCK_WorkSet");
 435   2                                               LCD_WriteNum(2,1,2,0,alarm_Time[3]);   
 436   2                                   if(key_value==3)
 437   2                                   {
 438   3                                                                      alarm_Time[3]++;
 439   3                                         if(alarm_Time[3]>1){alarm_Time[3]=0;}
 440   3                                   }
 441   2                                   if(key_value==7)
 442   2                                   {
 443   3                                                                      alarm_Time[3]--;
 444   3                                         if(alarm_Time[3]==-1){alarm_Time[3]=1;}
 445   3                                   }
 446   2                                   break;
 447   2              }
 448   1              key_value = 0xff;
 449   1      }
 450          
 451          void Timer0_Isr(void) interrupt 1
 452          {       
 453   1              static unsigned char icount = 0;                // 定时辅助计数
 454   1              if(icount==10)
 455   1              {
 456   2                      key_flag = 1;
 457   2                      icount=0;
 458   2              }
 459   1              icount++;
 460   1      }
 461          
 462           
 463          void Timer0_Init(void)          //1毫秒@11.0592MHz
 464          {
 465   1              AUXR |= 0x80;                   //定时器时钟1T模式
 466   1              TMOD &= 0xF0;                   //设置定时器模式
 467   1              TL0 = 0x20;                             //设置定时初始值
 468   1              TH0 = 0xD1;                             //设置定时初始值
 469   1              TF0 = 0;                                //清除TF0标志
 470   1              TR0 = 1;                                //定时器0开始计时
 471   1              ET0 = 1;                                //使能定时器0中断
 472   1              EA=1;
 473   1      }
 474          void main(void)
 475          {
 476   1              cls_buzz();
 477   1              DS1302_Init();
 478   1              LCD_Init();
 479   1              Timer0_Init();                                      
 480   1              DS1302_SetTime();
 481   1              LED(0xff);//关LED
 482   1              while(1)
 483   1              {
 484   2                      alarm();
C51 COMPILER V9.59.0.0   MAIN                                                              12/07/2024 22:40:31 PAGE 9   

 485   2                      if(key_flag)
 486   2          {
 487   3            key_flag = 0;
 488   3                              read_keyboard();
 489   3                              if(key_value != 0xFF)
 490   3                              {
 491   4                              LCD_Init();
 492   4                              KeyAction();
 493   4                              }
 494   3                      } 
 495   2                      Disply();
 496   2              }
 497   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2939    ----
   CONSTANT SIZE    =    228    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
